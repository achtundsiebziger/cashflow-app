let bills = [];
let currentDate = new Date();
const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

// Load data on start
loadData();
updateView();

function loadData() {
    const saved = localStorage.getItem('cashflow-bills');
    if (saved) bills = JSON.parse(saved);
}

function saveData() {
    localStorage.setItem('cashflow-bills', JSON.stringify(bills));
}

function showView(view) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    if (view === 'month') {
        document.getElementById('monthView').classList.remove('hidden');
        document.getElementById('yearView').classList.add('hidden');
    } else {
        document.getElementById('monthView').classList.add('hidden');
        document.getElementById('yearView').classList.remove('hidden');
        updateYearView();
    }
}

function toggleForm() {
    const form = document.getElementById('addForm');
    form.classList.toggle('hidden');
}

function addBill() {
    const name = document.getElementById('billName').value;
    const amount = parseFloat(document.getElementById('billAmount').value);
    const type = document.getElementById('billType').value;
    const category = document.getElementById('billCategory').value;
    const recurring = document.getElementById('billRecurring').checked;

    if (!name || !amount) {
        alert('Bitte fülle alle Felder aus!');
        return;
    }

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;

    const bill = { id: Date.now(), name, amount, type, category, year, month };
    bills.push(bill);

    if (recurring) {
        for (let i = 1; i <= 11; i++) {
            const futureDate = new Date(year, month - 1 + i);
            bills.push({
                id: Date.now() + i,
                name, amount, type, category,
                year: futureDate.getFullYear(),
                month: futureDate.getMonth() + 1
            });
        }
    }

    saveData();
    updateView();
    toggleForm();
    document.getElementById('billName').value = '';
    document.getElementById('billAmount').value = '';
}

function deleteBill(id) {
    if (confirm('Wirklich löschen?')) {
        bills = bills.filter(b => b.id !== id);
        saveData();
        updateView();
    }
}

function changeMonth(dir) {
    currentDate.setMonth(currentDate.getMonth() + dir);
    updateView();
}

function changeYear(dir) {
    currentDate.setFullYear(currentDate.getFullYear() + dir);
    updateYearView();
}

function updateView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${year}`;

    const currentBills = bills.filter(b => b.year === year && b.month === month);
    const income = currentBills.filter(b => b.type === 'income').reduce((sum, b) => sum + b.amount, 0);
    const expense = currentBills.filter(b => b.type === 'expense').reduce((sum, b) => sum + b.amount, 0);
    const balance = income - expense;

    document.getElementById('incomeTotal').textContent = income.toFixed(2) + ' €';
    document.getElementById('expenseTotal').textContent = expense.toFixed(2) + ' €';
    document.getElementById('balanceTotal').textContent = balance.toFixed(2) + ' €';

    const list = document.getElementById('billList');
    list.innerHTML = '';

    if (currentBills.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#6b7280; padding:40px;">Noch keine Einträge für diesen Monat</p>';
        return;
    }

    currentBills.forEach(bill => {
        const div = document.createElement('div');
        div.className = `bill-item ${bill.type}`;
        div.innerHTML = `
            <div class="bill-info">
                <h3>${bill.name}</h3>
                <div class="bill-amount ${bill.type}">
                    ${bill.type === 'income' ? '+' : '-'}${bill.amount.toFixed(2)} €
                </div>
            </div>
            <div class="bill-actions">
                <button class="btn-small btn-delete" onclick="deleteBill(${bill.id})">Löschen</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function updateYearView() {
    const year = currentDate.getFullYear();
    document.getElementById('currentYear').textContent = year;

    let yearIncome = 0, yearExpense = 0;
    const grid = document.getElementById('yearGrid');
    grid.innerHTML = '';

    for (let m = 1; m <= 12; m++) {
        const monthBills = bills.filter(b => b.year === year && b.month === m);
        const income = monthBills.filter(b => b.type === 'income').reduce((sum, b) => sum + b.amount, 0);
        const expense = monthBills.filter(b => b.type === 'expense').reduce((sum, b) => sum + b.amount, 0);
        const balance = income - expense;

        yearIncome += income;
        yearExpense += expense;

        const div = document.createElement('div');
        div.className = 'year-month';
        div.onclick = () => {
            currentDate.setMonth(m - 1);
            showView('month');
            updateView();
        };
        div.innerHTML = `
            <h3>${monthNames[m - 1]}</h3>
            <div class="year-stat">
                <span>Einnahmen:</span>
                <span style="color:#10b981; font-weight:600;">+${income.toFixed(2)} €</span>
            </div>
            <div class="year-stat">
                <span>Ausgaben:</span>
                <span style="color:#ef4444; font-weight:600;">-${expense.toFixed(2)} €</span>
            </div>
            <div class="year-stat" style="border-top:2px solid #e5e7eb; padding-top:8px; margin-top:8px;">
                <span style="font-weight:600;">Saldo:</span>
                <span style="color:${balance >= 0 ? '#6366f1' : '#f59e0b'}; font-weight:700; font-size:1.1em;">
                    ${balance.toFixed(2)} €
                </span>
            </div>
        `;
        grid.appendChild(div);
    }

    document.getElementById('yearIncomeTotal').textContent = yearIncome.toFixed(2) + ' €';
    document.getElementById('yearExpenseTotal').textContent = yearExpense.toFixed(2) + ' €';
    document.getElementById('yearBalanceTotal').textContent = (yearIncome - yearExpense).toFixed(2) + ' €';
}

function exportData() {
    const dataStr = JSON.stringify(bills, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cashflow-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

function importData(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                bills = JSON.parse(e.target.result);
                saveData();
                updateView();
                alert('Daten erfolgreich importiert!');
            } catch (error) {
                alert('Fehler beim Import!');
            }
        };
        reader.readAsText(file);
    }
}